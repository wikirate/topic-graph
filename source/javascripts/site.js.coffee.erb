$.fn.select2.defaults.set("theme", "bootstrap4")

#API_HOST = "https://wikirate.org"
API_HOST = "data"
METRIC_URL = "#{API_HOST}/Metric.json"
TOPIC_URL = "#{API_HOST}/topic.json"

topicGraph = null

configs = {
  default:
    font_size: 20
    node_size: 1
    edge_size: 1
    simple_weight: false
    edge_threshold: 2
    node_threshold: 2
    colorful: false
  solar:
    font_size: 20
    node_size: 1
    edge_size: 1
    simple_weight: false
    edge_threshold: 2
    node_threshold: 130
    colorful: false
  chaos:
    font_size: 20
    node_size: 1
    edge_size: 1
    simple_weight: true
    edge_threshold: 1
    node_threshold: 1
    colorful: true
}

$(document).ready ->
  $("#configs").select2()
  container = document.getElementById("topicgraph")
  initGraph(metrics, topics, container)
  # loadGraph("topicgraph")

  $("body").on "change", "._edge-threshold", ->
    topicGraph.options.edge_threshold = parseFloat($(this).val())
    topicGraph.updateEdges()
    update()

  $("body").on "change", "._node-threshold", ->
    topicGraph.options.node_threshold = parseFloat($(this).val())
    topicGraph.updateNodes()
    update()

  $("body").on "change", "._font-size", ->
    topicGraph.options.font_size = parseInt($(this).val())
    update()

  $("body").on "change", "._edge-size", ->
    topicGraph.options.edge_size = parseFloat($(this).val())
    topicGraph.updateEdges()
    update()

  $("body").on "change", "._node-size", ->
    topicGraph.options.node_size = parseFloat($(this).val())
    topicGraph.updateNodes()
    update()

  $("body").on "change", "#configs", ->
    selected = $(this).select2("data")
    topicGraph.loadConfig(configs[selected[0].id])
    topicGraph.updateEdges()
    topicGraph.updateNodes()
    update()

  $("body").on "change", "._colorful", ->
    topicGraph.options.colorful = this.checked
    topicGraph.updateNodes()
    update()

  $("body").on "change", "._connection-formula", ->
    if $('input[name=formulaRadios]:checked').val() == "simple"
      topicGraph.options.simple_weight = true
    else
      topicGraph.options.simple_weight = false
    topicGraph.updateEdges()
    update()

VAL_FIELDS = {
  edge_threshold: "edge-threshold"
  node_threshold: "node-threshold"
  font_size: "font-size"
  node_size: "node-size"
  edge_size: "edge-size"
}

initGraph = (metrics, topics, container) ->
  topicGraph = new TopicGraph(metrics, topics, container)
  for option, css_class of VAL_FIELDS
    $("._#{css_class}").val(topicGraph.options[option])

  value = if topicGraph.options.simple_weight then "simple" else "weighted"
  $("input[value='#{value}']").prop("checked", true)
  $("._colorful").prop("checked", topicGraph.options.colorful)
  topicGraph.updateEdges()
  topicGraph.updateNodes()
  update()

update = () ->
  topicGraph.render()
  for option, value of topicGraph.options
    $("._#{VAL_FIELDS[option]}").val(value)
  $("._topic-count").text(topicGraph.topic_count)
  $("._topic-connection-count").text(topicGraph.topic_connection_count)
  $("._edge-count").text(topicGraph.edges.length)
  $("._node-count").text(topicGraph.nodes.length)

loadGraph = (containerId) ->
  $.ajax(
    url: METRIC_URL,
    cache: false,
    dataType: "json",
    type: "GET",
    crossDomain: true,
    contentType: "application/json",
    headers: {
      "accept": "application/json",
      "Access-Control-Allow-Origin":"*",
      "Access-Control-Allow-Headers": "x-requested-with"
  }).done (metricData) ->
    $.ajax(url: TOPIC_URL, cache: false, dataType: "json", crossDomain: true, "headers": {
      "accept": "application/json",
      "Access-Control-Allow-Origin":"*"
    }).done (topicData) ->
      container = document.getElementById("topicgraph")
      initGraph(metricData, topicData, container)
